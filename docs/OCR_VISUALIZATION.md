# OCR 区域可视化工具使用指南

## 概述

`visualize_ocr_regions.py` 是一个 OCR 区域可视化工具，可以：
- 读取图片并识别每个区域（1-9）的文字
- 在图片上用彩色方框标注识别到的文字
- 显示每个文字的坐标位置
- 生成标注后的图片供调试使用

## 使用方法

### 基本用法

```bash
python visualize_ocr_regions.py
```

默认读取 `/tmp/s2.png`，输出到 `/tmp/s2_annotated.png`

### 自定义输入输出

修改脚本中的路径：

```python
def main():
    image_path = "/path/to/your/image.png"
    output_path = "/path/to/output.png"
    
    visualize_all_regions(image_path, output_path)
```

## 输出文件

脚本会生成以下文件：

1. **标注图片**：`/tmp/s2_annotated.png`
   - 完整尺寸的标注图片
   - 包含所有识别到的文字边界框和坐标

2. **缩放图片**：`/tmp/s2_annotated_small.png`
   - 50% 缩放的图片，方便查看

3. **区域截图**：`/tmp/region_1_debug.png` ~ `/tmp/region_9_debug.png`
   - 每个区域的单独截图
   - 用于调试区域提取是否正确

## 区域编号

图片被分成 3x3 网格，共 9 个区域：

```
1  2  3
4  5  6
7  8  9
```

每个区域用不同颜色标注：
- 区域 1：蓝色
- 区域 2：绿色
- 区域 3：红色
- 区域 4：青色
- 区域 5：品红
- 区域 6：黄色
- 区域 7：紫色
- 区域 8：橙色
- 区域 9：天蓝色

## 标注说明

### 边界框
- 每个识别到的文字都有彩色边界框
- 边界框颜色对应所在区域的颜色

### 中心点
- 每个文字的中心点用实心圆点标注
- 圆点颜色与边界框相同

### 文字标签
- 格式：`文字内容(x坐标,y坐标)`
- 例如：`战斗(361,1244)`
- 标签显示在边界框上方
- 有彩色背景，白色文字

## 示例输出

### /tmp/s2.png 识别结果

```
============================================================
OCR 区域可视化工具
============================================================
✅ 图像尺寸: 720x1280

🔍 开始识别各个区域的文字...

📍 区域 1:
   ✅ 识别到 15 个文字
      - 'P:0/1' at (25, 10) [置信度: 0.96]
      - 'dX:0.0' at (125, 9) [置信度: 0.94]
      - '我的' at (43, 98) [置信度: 1.00]
      - '客服' at (43, 256) [置信度: 1.00]
      ...

📍 区域 2:
   ✅ 识别到 9 个文字
      - '369666112' at (300, 41) [置信度: 1.00]
      - '98898632' at (280, 74) [置信度: 1.00]
      - '复制' at (356, 74) [置信度: 1.00]
      ...

📍 区域 3:
   ✅ 识别到 7 个文字
      - '切换账号' at (561, 58) [置信度: 0.98]
      - '已实名' at (586, 194) [置信度: 1.00]
      ...

✅ 总共识别到 44 个文字
✅ 标注图像已保存到: /tmp/s2_annotated.png
✅ 缩放图像已保存到: /tmp/s2_annotated_small.png
```

## 调试技巧

### 1. 检查区域提取

查看 `/tmp/region_X_debug.png` 文件，确认区域提取是否正确：
- 区域边界是否正确
- 区域内容是否完整
- 是否有文字被切断

### 2. 检查坐标转换

标注图片上的坐标应该是相对于原图的：
- 区域 1 的文字坐标应该在左上角（x < 240, y < 426）
- 区域 9 的文字坐标应该在右下角（x > 480, y > 852）

### 3. 检查识别质量

- 置信度低于 0.5 的文字会被过滤
- 如果某些文字未被识别，检查：
  - 图片清晰度
  - 文字大小
  - 文字颜色对比度

## 常见问题

### Q1: 某个区域没有识别到文字

**可能原因**：
- 该区域确实没有文字
- 文字太小或太模糊
- 文字颜色与背景对比度太低

**解决方案**：
- 查看 `/tmp/region_X_debug.png` 确认区域内容
- 提高图片分辨率
- 调整 OCR 参数

### Q2: 坐标显示不正确

**可能原因**：
- 坐标转换有误
- 区域偏移计算错误

**解决方案**：
- 检查日志中的"区域范围"和"偏移量"
- 验证：`原图坐标 = 区域坐标 + 偏移量`

### Q3: 标注文字重叠

**可能原因**：
- 文字密集
- 标签太长

**解决方案**：
- 修改脚本中的字体大小
- 调整标签位置算法

## 高级用法

### 只识别特定区域

修改脚本，只处理需要的区域：

```python
# 只识别区域 7, 8, 9（底部）
for region_id in [7, 8, 9]:
    # ... 识别代码
```

### 自定义颜色

修改 `region_colors` 字典：

```python
region_colors = {
    1: (255, 0, 0),      # 自定义颜色 (B, G, R)
    2: (0, 255, 0),
    # ...
}
```

### 调整置信度阈值

修改过滤条件：

```python
if score < 0.7:  # 提高阈值到 0.7
    continue
```

## 性能优化

### 1. 跳过空区域

如果某些区域通常是空的，可以跳过：

```python
skip_regions = [7, 8, 9]  # 跳过底部区域
for region_id in range(1, 10):
    if region_id in skip_regions:
        continue
    # ... 识别代码
```

### 2. 并行处理

对于大量图片，可以使用多进程：

```python
from multiprocessing import Pool

def process_image(image_path):
    output_path = image_path.replace(".png", "_annotated.png")
    visualize_all_regions(image_path, output_path)

with Pool(4) as p:
    p.map(process_image, image_paths)
```

## 相关文件

- `visualize_ocr_regions.py` - 主脚本
- `ocr_helper.py` - OCR 辅助类
- `tests/test_ocr_debug.py` - OCR 调试测试
- `docs/OCR_REGION_SEARCH.md` - OCR 区域搜索文档

## 更新日志

- 2025-01-09: 初始版本，支持 9 个区域的可视化

