# 超时保护机制指南

## 概述

为了防止程序因网络错误、误识别等原因卡在某个循环处，我们添加了超时检测机制。使用 `wrapt-timeout-decorator` 库为关键函数添加了超时装饰器，并在超时时自动重启程序。

## 已添加超时的函数

以下函数已添加超时保护：

1. **`start_bluestacks()`** - 300秒（5分钟）
   - 防止启动模拟器时无限等待

2. **`find_text()`** - 30秒
   - 防止查找文本时因识别失败而卡住

3. **`auto_combat()`** - 300秒（5分钟）
   - 防止自动战斗时陷入死循环

4. **`wait_for_main()`** - 内部已有300秒超时
   - 等待回到主界面，已有内置超时机制

5. **`back_to_main()`** - 60秒
   - 防止返回主界面时无限点击返回按钮

6. **`process_dungeon()`** - 300秒（5分钟）
   - 防止处理单个副本时卡住

7. **`run_dungeon_traversal()`** - 1800秒（30分钟）
   - 防止整个副本遍历过程卡住

8. **`collect_daily_rewards()`** - 300秒（5分钟）
   - 防止每日收集操作卡住

9. **`daily_collect()`** - 300秒（5分钟）
   - 防止每日收集函数卡住

## 重启机制

程序入口已从 `main()` 改为 `main_wrapper()`，实现了以下功能：

- **最大重启次数**：3次
- **超时检测**：捕获所有 `TimeoutError` 异常
- **自动重启**：超时后清理全局变量并重新执行
- **通知机制**：通过 Bark 发送超时和重启通知
- **错误日志**：详细记录超时原因和重启次数

## 使用方法

程序运行方式不变：

```bash
python auto_dungeon.py
```

当发生超时时，程序会：

1. 记录超时错误
2. 发送 Bark 通知
3. 等待5秒后自动重启
4. 清理全局变量重新初始化
5. 如果达到最大重启次数（3次），则退出程序

## 注意事项

1. **超时时间设置**：最长动作（打副本）不超过5分钟，整体流程不超过30分钟
2. **通知配置**：确保 `system_config.json` 中正确配置了 Bark 通知
3. **日志查看**：超时和重启信息会记录在日志中
4. **手动停止**：仍然可以通过创建 `.stop_dungeon` 文件来优雅停止

## 测试

运行测试脚本验证超时机制：

```bash
python test_timeout_decorator.py
```

该脚本会测试：
- 正常完成的函数（不会超时）
- 会超时的函数
- 超时后重启逻辑

## 故障排除

如果程序频繁超时重启：

1. 检查网络连接是否稳定
2. 确认游戏界面没有异常弹窗
3. 检查 OCR 识别是否正常
4. 查看日志中的具体超时函数
5. 必要时可以调整相应函数的超时时间

## 技术细节

- 使用 `wrapt-timeout-decorator` 库实现函数级超时
- 超时异常类型：`TimeoutError`
- 重启时会清理以下全局变量：
  - `config_loader`
  - `system_config`
  - `zone_dungeons`
  - `ocr_helper`
- 每次重启间隔：5秒
