# Loki 架构可视化指南

## 1. 数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│ Python 应用（auto_dungeon.py）                                   │
│                                                                   │
│  logger.info("应用启动")                                          │
│       ↓                                                           │
│  logging.LogRecord                                               │
│  {                                                               │
│    name: "miniwow",                                              │
│    levelname: "INFO",                                            │
│    message: "应用启动",                                           │
│    filename: "auto_dungeon.py",                                  │
│    lineno: 1725,                                                 │
│    funcName: "main"                                              │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│ LokiHandler.emit()                                               │
│                                                                   │
│  提取日志信息：                                                   │
│  log_entry = {                                                   │
│    "timestamp": 1730534445000000000,                             │
│    "level": "INFO",                                              │
│    "logger": "miniwow",                                          │
│    "message": "应用启动",                                         │
│    "module": "auto_dungeon",                                     │
│    "function": "main",                                           │
│    "line": 1725                                                  │
│  }                                                               │
│                                                                   │
│  添加到缓冲区                                                     │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│ 后台上传线程（每 5 秒）                                           │
│                                                                   │
│  构建 Loki 请求格式：                                             │
│  {                                                               │
│    "streams": [                                                  │
│      {                                                           │
│        "stream": {                                               │
│          "app": "miniwow",                                       │
│          "host": "docker-host",                                  │
│          "config": "account1"                                    │
│        },                                                        │
│        "values": [                                               │
│          [                                                       │
│            "1730534445000000000",                                │
│            "{\"level\":\"INFO\",\"message\":\"应用启动\"}"        │
│          ]                                                       │
│        ]                                                         │
│      }                                                           │
│    ]                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│ HTTP POST 请求                                                   │
│                                                                   │
│  POST http://docker.home:3100/loki/api/v1/push                  │
│  Content-Type: application/json; charset=utf-8                  │
│                                                                   │
│  [JSON 数据]                                                      │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│ Loki 服务                                                        │
│                                                                   │
│  1. 解析标签：{app, host, config}                                │
│  2. 创建或更新 Stream                                             │
│  3. 存储日志内容（JSON）                                          │
│  4. 建立索引                                                      │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│ Loki 数据库                                                      │
│                                                                   │
│  Stream: {app="miniwow", host="docker-host", config="account1"} │
│    ├─ 时间戳1 → 日志内容1（JSON）                                │
│    ├─ 时间戳2 → 日志内容2（JSON）                                │
│    └─ 时间戳3 → 日志内容3（JSON）                                │
│                                                                   │
│  Stream: {app="miniwow", host="docker-host", config="account2"} │
│    ├─ 时间戳1 → 日志内容1（JSON）                                │
│    └─ 时间戳2 → 日志内容2（JSON）                                │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│ Grafana 查询                                                     │
│                                                                   │
│  查询语句：{config="account1"} | json | level="ERROR"            │
│                                                                   │
│  1. 使用标签索引快速定位 Stream                                   │
│  2. 解析 JSON 内容                                                │
│  3. 按 level="ERROR" 过滤                                         │
│  4. 返回结果                                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 标签 vs 内容对比

```
┌──────────────────────────────────────────────────────────────────┐
│                    Loki 数据结构                                   │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  第一层：标签（Labels）- 用于索引                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ {                                                          │  │
│  │   "app": "miniwow",          ← 应用名称                    │  │
│  │   "host": "docker-host",     ← 主机名                      │  │
│  │   "config": "account1",      ← 配置文件                    │  │
│  │   "env": "production"        ← 环境                        │  │
│  │ }                                                          │  │
│  │                                                            │  │
│  │ 特点：                                                      │  │
│  │ • 数量有限（5-10 个）                                       │  │
│  │ • 值离散且有限                                              │  │
│  │ • 用于数据库索引                                            │  │
│  │ • 查询速度快（⚡⚡⚡ 毫秒级）                                │  │
│  └────────────────────────────────────────────────────────────┘  │
│                          ↓                                        │
│  第二层：日志内容（Log Content）- 详细信息                         │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ {                                                          │  │
│  │   "level": "INFO",           ← 日志级别                    │  │
│  │   "logger": "miniwow",       ← Logger 名称                 │  │
│  │   "message": "应用启动",      ← 日志消息                    │  │
│  │   "module": "auto_dungeon",  ← 模块名                      │  │
│  │   "function": "main",        ← 函数名                      │  │
│  │   "line": 1725               ← 行号                        │  │
│  │ }                                                          │  │
│  │                                                            │  │
│  │ 特点：                                                      │  │
│  │ • 数量无限                                                  │  │
│  │ • 可以包含任意信息                                          │  │
│  │ • 用于详细查询和分析                                        │  │
│  │ • 查询速度相对较慢（⚡⚡ 秒级）                              │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 3. Stream 概念

```
┌─────────────────────────────────────────────────────────────────┐
│ Loki 中的 Stream 概念                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Stream = 标签组合 + 时间序列日志                                  │
│                                                                   │
│ 示例 1：account1 的日志流                                         │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Stream 标签：{app="miniwow", config="account1"}             │ │
│ │                                                             │ │
│ │ 时间序列数据：                                               │ │
│ │   时间戳1 → {"level":"INFO","message":"应用启动"}           │ │
│ │   时间戳2 → {"level":"INFO","message":"加载配置"}           │ │
│ │   时间戳3 → {"level":"ERROR","message":"连接失败"}          │ │
│ │   时间戳4 → {"level":"INFO","message":"重新连接"}           │ │
│ │   ...                                                       │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ 示例 2：account2 的日志流                                         │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Stream 标签：{app="miniwow", config="account2"}             │ │
│ │                                                             │ │
│ │ 时间序列数据：                                               │ │
│ │   时间戳1 → {"level":"INFO","message":"应用启动"}           │ │
│ │   时间戳2 → {"level":"WARNING","message":"内存不足"}        │ │
│ │   ...                                                       │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ 关键点：                                                          │
│ • 相同标签的日志进入同一个 Stream                                 │
│ • 不同标签创建不同的 Stream                                       │
│ • 每个 Stream 是一个独立的时间序列                                │
│ • Loki 对每个 Stream 分别建立索引                                 │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 查询流程

```
┌─────────────────────────────────────────────────────────────────┐
│ Grafana 查询流程                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ 查询 1：{config="account1"}                                       │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 1. Loki 使用标签索引                                         │ │
│ │    ↓                                                         │ │
│ │ 2. 快速定位 Stream: {app="miniwow", config="account1"}      │ │
│ │    ↓                                                         │ │
│ │ 3. 返回该 Stream 中的所有日志                                │ │
│ │    ↓                                                         │ │
│ │ 性能：⚡⚡⚡ 毫秒级                                           │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ 查询 2：{config="account1"} | json | level="ERROR"               │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 1. Loki 使用标签索引                                         │ │
│ │    ↓                                                         │ │
│ │ 2. 快速定位 Stream: {app="miniwow", config="account1"}      │ │
│ │    ↓                                                         │ │
│ │ 3. 对每条日志解析 JSON                                       │ │
│ │    ↓                                                         │ │
│ │ 4. 按 level="ERROR" 过滤                                     │ │
│ │    ↓                                                         │ │
│ │ 5. 返回过滤后的日志                                          │ │
│ │    ↓                                                         │ │
│ │ 性能：⚡⚡ 秒级                                              │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ 查询 3：{app="miniwow"} | "副本"                                  │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 1. Loki 使用标签索引                                         │ │
│ │    ↓                                                         │ │
│ │ 2. 定位所有 app="miniwow" 的 Stream                          │ │
│ │    ↓                                                         │ │
│ │ 3. 扫描所有日志内容                                          │ │
│ │    ↓                                                         │ │
│ │ 4. 按关键词 "副本" 过滤                                       │ │
│ │    ↓                                                         │ │
│ │ 5. 返回过滤后的日志                                          │ │
│ │    ↓                                                         │ │
│ │ 性能：⚡ 秒-分钟级                                           │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 标签设计决策树

```
┌─────────────────────────────────────────────────────────────────┐
│ 这个字段应该作为标签吗？                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│                    开始                                           │
│                      ↓                                            │
│         这个字段的值是否有限？                                     │
│         (通常 < 1000 个不同的值)                                  │
│                      ↓                                            │
│              ┌───────┴───────┐                                    │
│              ↓               ↓                                    │
│             是              否                                    │
│              ↓               ↓                                    │
│         继续检查      ❌ 不作为标签                                │
│              ↓         (放在日志内容中)                           │
│    这个字段是否用于                                               │
│    快速过滤日志？                                                 │
│              ↓                                                    │
│         ┌────┴────┐                                               │
│         ↓         ↓                                               │
│        是        否                                               │
│         ↓         ↓                                               │
│    ✅ 作为标签  ❌ 不作为标签                                      │
│         ↓         ↓                                               │
│      (索引)   (放在日志内容中)                                    │
│                                                                   │
│ 示例：                                                            │
│ • app: "miniwow"           → ✅ 作为标签（值有限，常用于过滤）    │
│ • config: "account1"       → ✅ 作为标签（值有限，常用于过滤）    │
│ • level: "INFO"            → ❌ 不作为标签（放在日志内容中）      │
│ • message: "应用启动"       → ❌ 不作为标签（值无限）             │
│ • user_id: "12345"         → ❌ 不作为标签（值无限，高基数）      │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 性能优化建议

```
┌─────────────────────────────────────────────────────────────────┐
│ Loki 查询性能优化                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ ❌ 不好的查询（全文搜索）                                         │
│ {app="miniwow"} | "副本"                                         │
│ 性能：🐢 秒-分钟级                                               │
│                                                                   │
│ ✅ 更好的查询（先用标签过滤）                                     │
│ {config="account1"} | "副本"                                     │
│ 性能：⚡ 秒级                                                    │
│                                                                   │
│ ✅✅ 最好的查询（标签 + JSON 过滤）                               │
│ {config="account1"} | json | level="ERROR"                      │
│ 性能：⚡⚡ 秒级                                                  │
│                                                                   │
│ ✅✅✅ 最优的查询（仅使用标签）                                   │
│ {config="account1"}                                              │
│ 性能：⚡⚡⚡ 毫秒级                                              │
│                                                                   │
│ 优化建议：                                                        │
│ 1. 尽可能使用标签过滤                                             │
│ 2. 在标签过滤的基础上再用内容过滤                                 │
│ 3. 避免全文搜索（除非必要）                                       │
│ 4. 合理设计标签，使其能覆盖常见的查询场景                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

