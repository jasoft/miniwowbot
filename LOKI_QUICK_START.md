# Loki æ—¥å¿—ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ—¥å¿—æ”¶é›†å’ŒæŸ¥è¯¢ç³»ç»Ÿï¼ŒåŸºäº Loki + Grafanaï¼Œå¯ä»¥ï¼š
- ğŸ“± é€šè¿‡æ‰‹æœº APP æŸ¥çœ‹æ—¥å¿—
- ğŸŒ é€šè¿‡ç½‘ç»œæµè§ˆå™¨æŸ¥çœ‹æ—¥å¿—
- ğŸ” å¿«é€Ÿæœç´¢å’Œè¿‡æ»¤æ—¥å¿—
- ğŸ“Š å®æ—¶ç›‘æ§åº”ç”¨çŠ¶æ€

## å¿«é€Ÿå¼€å§‹ï¼ˆ5 åˆ†é’Ÿï¼‰

### ç¬¬ 1 æ­¥ï¼šå¯åŠ¨ Loki å’Œ Grafana

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/weiwang/Projects/miniwow

# å¯åŠ¨ Docker å®¹å™¨
docker-compose -f docker-compose.loki.yml up -d
```

### ç¬¬ 2 æ­¥ï¼šéªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker-compose -f docker-compose.loki.yml ps

# åº”è¯¥çœ‹åˆ°ä¸¤ä¸ªå®¹å™¨ï¼šloki å’Œ grafana
```

### ç¬¬ 3 æ­¥ï¼šè®¿é—® Grafana

1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://localhost:3000
2. ç”¨æˆ·åï¼š`admin`
3. å¯†ç ï¼š`admin`
4. é¦–æ¬¡ç™»å½•ä¼šè¦æ±‚ä¿®æ”¹å¯†ç ï¼ˆå¯é€‰ï¼‰

### ç¬¬ 4 æ­¥ï¼šåœ¨ä»£ç ä¸­ä½¿ç”¨

```python
from logstash_logger import create_loki_logger

# åˆ›å»ºæ—¥å¿—è®°å½•å™¨
logger = create_loki_logger(
    name="miniwow",
    level="INFO",
    loki_url="http://localhost:3100",
    enable_loki=True,
)

# è®°å½•æ—¥å¿—
logger.info("åº”ç”¨å¯åŠ¨")
logger.warning("è­¦å‘Šä¿¡æ¯")
logger.error("é”™è¯¯ä¿¡æ¯")
```

### ç¬¬ 5 æ­¥ï¼šåœ¨ Grafana ä¸­æŸ¥çœ‹æ—¥å¿—

1. ç‚¹å‡»å·¦ä¾§èœå•çš„ "Explore"
2. é€‰æ‹©æ•°æ®æº "Loki"
3. åœ¨æŸ¥è¯¢æ¡†ä¸­è¾“å…¥æ ‡ç­¾è¿‡æ»¤ï¼š`{app="miniwow"}`
4. ç‚¹å‡» "Run query" æŸ¥çœ‹æ—¥å¿—

## æ—¥å¿—æŸ¥è¯¢è¯­æ³•

### åŸºæœ¬æŸ¥è¯¢

```
# æŸ¥è¯¢æ‰€æœ‰ miniwow åº”ç”¨çš„æ—¥å¿—
{app="miniwow"}

# æŸ¥è¯¢ç‰¹å®šä¸»æœºçš„æ—¥å¿—
{app="miniwow", host="my-host"}

# æŸ¥è¯¢åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æ—¥å¿—
{app="miniwow"} |= "error"

# æŸ¥è¯¢ä¸åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æ—¥å¿—
{app="miniwow"} != "debug"
```

### é«˜çº§æŸ¥è¯¢

```
# æŸ¥è¯¢ ERROR çº§åˆ«çš„æ—¥å¿—
{app="miniwow"} | json | level="ERROR"

# æŸ¥è¯¢ç‰¹å®šæ¨¡å—çš„æ—¥å¿—
{app="miniwow"} | json | module="emulator_manager"

# ç»Ÿè®¡æ—¥å¿—æ•°é‡
{app="miniwow"} | json | level="ERROR" | stats count()
```

## ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š

```env
# Loki æœåŠ¡åœ°å€
LOKI_URL=http://localhost:3100

# æ˜¯å¦å¯ç”¨ Loki
LOKI_ENABLED=true
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åœæ­¢ Loki å’Œ Grafanaï¼Ÿ

```bash
docker-compose -f docker-compose.loki.yml down
```

### Q: å¦‚ä½•æŸ¥çœ‹æ—¥å¿—ï¼Ÿ

1. åœ¨ Grafana ä¸­ç‚¹å‡» "Explore"
2. é€‰æ‹© "Loki" æ•°æ®æº
3. è¾“å…¥æŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚ `{app="miniwow"}`

### Q: å¦‚ä½•åˆ é™¤æ—§æ—¥å¿—ï¼Ÿ

Loki é»˜è®¤ä¿ç•™æ‰€æœ‰æ—¥å¿—ã€‚å¦‚æœéœ€è¦è‡ªåŠ¨åˆ é™¤æ—§æ—¥å¿—ï¼Œä¿®æ”¹ `loki-config.yml` ä¸­çš„ `retention_period`ã€‚

### Q: å¦‚ä½•åœ¨æ‰‹æœºä¸ŠæŸ¥çœ‹æ—¥å¿—ï¼Ÿ

1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ç½‘ç»œ
2. åœ¨æ‰‹æœºæµè§ˆå™¨ä¸­è®¿é—® `http://<ä½ çš„ç”µè„‘IP>:3000`
3. ç™»å½• Grafana å¹¶æŸ¥çœ‹æ—¥å¿—

### Q: å¦‚ä½•ä¿®æ”¹ Grafana å¯†ç ï¼Ÿ

1. ç™»å½• Grafana
2. ç‚¹å‡»å·¦ä¸‹è§’çš„ç”¨æˆ·å¤´åƒ
3. é€‰æ‹© "Change password"

## é›†æˆåˆ°ç°æœ‰ä»£ç 

### æ–¹å¼ 1ï¼šæ›¿æ¢ç°æœ‰æ—¥å¿—é…ç½®

```python
# åŸæ¥çš„ä»£ç 
from logger_config import setup_logger
logger = setup_logger(name="auto_dungeon")

# æ”¹ä¸º
from logstash_logger import create_loki_logger
logger = create_loki_logger(name="auto_dungeon")
```

### æ–¹å¼ 2ï¼šåŒæ—¶ä½¿ç”¨æ§åˆ¶å°å’Œ Loki

```python
from logstash_logger import create_loki_logger

# åˆ›å»ºæ—¥å¿—è®°å½•å™¨ï¼ŒåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œ Loki
logger = create_loki_logger(
    name="auto_dungeon",
    level="INFO",
    loki_url="http://localhost:3100",
    enable_loki=True,
)
```

## æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Python åº”ç”¨                            â”‚
â”‚  (auto_dungeon.py, emulator_manager.py, ç­‰)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ æ—¥å¿—è®°å½•
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              logstash_logger.py                          â”‚
â”‚  (LokiHandler - ç¼“å†²å’Œä¸Šä¼ æ—¥å¿—)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ HTTP POST
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Loki (3100)                            â”‚
â”‚  (æ—¥å¿—å­˜å‚¨å’ŒæŸ¥è¯¢)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ æŸ¥è¯¢
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Grafana (3000)                           â”‚
â”‚  (Web UI - æµè§ˆå™¨å’Œæ‰‹æœº APP)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‹ä¸€æ­¥

1. å¯åŠ¨ Loki å’Œ Grafana
2. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š`python test_loki_logger.py`
3. åœ¨ Grafana ä¸­æŸ¥çœ‹æ—¥å¿—
4. é›†æˆåˆ°ä½ çš„åº”ç”¨ä»£ç ä¸­

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [Loki å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/loki/latest/)
- [Grafana å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/grafana/latest/)

