# 自动化市场查询脚本使用指南

## 概述

`auto_market_query.py` 是一个自动化市场查询脚本，用于在游戏模拟器中自动查询市场价格，并在价格低于 100k 时自动购买。

## 功能特性

- ✅ **定时查询** - 每 5 秒点击一次查询按钮（可配置）
- ✅ **智能识别** - 使用 OCR 识别全屏幕文字，准确定位"一口价"按钮
- ✅ **价格提取** - 从"一口价"按钮右侧提取价格信息
- ✅ **灵活格式** - 支持 `2000k`、`89888` 等多种价格格式
- ✅ **自动购买** - 当价格 < 100k 时自动执行购买流程
- ✅ **日志记录** - 详细的日志输出，便于调试和监控

## 安装依赖

脚本依赖于以下模块（项目中已包含）：
- `airtest` - 模拟器自动化框架
- `paddleocr` - OCR 文字识别
- `logger_config` - 日志配置
- `ocr_helper` - OCR 辅助工具
- `emulator_manager` - 模拟器管理工具

## 使用方法

### 基础使用

```bash
# 使用默认配置运行
python auto_market_query.py
```

### 自定义按钮位置

```bash
# 指定查询按钮和确定按钮的坐标
python auto_market_query.py \
  --query-x 360 \
  --query-y 640 \
  --confirm-x 360 \
  --confirm-y 1000
```

### 自定义查询间隔

```bash
# 设置查询间隔为 10 秒
python auto_market_query.py --interval 10
```

### 限制迭代次数

```bash
# 只执行 100 次查询后停止
python auto_market_query.py --max-iterations 100
```

### 指定模拟器

```bash
# 连接到特定的模拟器
python auto_market_query.py --emulator 127.0.0.1:5555
```

### 组合使用

```bash
# 完整示例：自定义所有参数
python auto_market_query.py \
  --query-x 360 \
  --query-y 640 \
  --confirm-x 360 \
  --confirm-y 1000 \
  --interval 5 \
  --max-iterations 50 \
  --emulator 127.0.0.1:5555
```

## 命令行参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--query-x` | int | 360 | 查询按钮的 X 坐标 |
| `--query-y` | int | 640 | 查询按钮的 Y 坐标 |
| `--confirm-x` | int | 360 | 确定按钮的 X 坐标 |
| `--confirm-y` | int | 1000 | 确定按钮的 Y 坐标 |
| `--interval` | int | 5 | 查询间隔（秒） |
| `--max-iterations` | int | None | 最大迭代次数（None 表示无限循环） |
| `--emulator` | str | None | 模拟器网络地址（如：127.0.0.1:5555） |

## 工作流程

1. **初始化** - 连接到模拟器，初始化 OCR 助手
2. **启动游戏** - 启动游戏应用
3. **主循环** - 每隔指定秒数执行以下步骤：
   - 点击查询按钮
   - 等待界面刷新
   - 获取全屏幕 OCR 结果
   - 查找"一口价"按钮
   - 从按钮右侧提取价格信息
   - 解析价格（支持 `2000k` 和 `89888` 格式）
   - 如果价格 < 100k，执行购买流程：
     - 点击一口价按钮
     - 点击确定按钮
   - 等待指定间隔后继续

## 价格格式支持

脚本支持以下价格格式：

| 格式 | 示例 | 解析结果 |
|------|------|---------|
| k 后缀 | `2000k` | 2,000,000 |
| 纯数字 | `89888` | 89,888 |
| 小数 k | `2.5k` | 2,500 |
| 带空格 | `2000 k` | 2,000,000 |

## 日志输出

脚本会输出详细的日志信息，包括：

```
✅ 找到一口价按钮: 一口价 位置: (360, 640)
💰 识别到价格: 50k (50000 金币) 位置: (450, 640)
🎯 金币数量 (50000) < 100k，执行购买流程
💰 点击一口价按钮: (850, 610)
✅ 点击确定按钮: (360, 1000)
✅ 购买流程完成
```

## 故障排除

### 问题：未找到一口价按钮

**原因**：
- OCR 识别失败
- 按钮不在屏幕上
- 按钮文字被遮挡

**解决方案**：
- 检查模拟器是否正常运行
- 确保游戏界面清晰可见
- 调整 OCR 置信度阈值

### 问题：价格识别错误

**原因**：
- 价格文本被其他文字遮挡
- 价格格式不符合预期

**解决方案**：
- 检查游戏界面布局
- 查看日志输出中的识别结果
- 调整价格查找范围

### 问题：点击位置不准确

**原因**：
- 按钮坐标配置错误
- 屏幕分辨率与配置不匹配

**解决方案**：
- 使用 `capture_and_analyze.py` 工具获取正确的坐标
- 根据实际屏幕分辨率调整坐标

## 中断脚本

按 `Ctrl+C` 可以随时中断脚本执行。脚本会捕获中断信号并正常退出。

## 测试

运行单元测试验证脚本功能：

```bash
python -m pytest tests/test_auto_market_query.py -v
```

所有 13 个测试用例都应该通过。

## 注意事项

1. **模拟器连接** - 确保模拟器已启动并可以连接
2. **游戏状态** - 确保游戏已启动并处于可操作状态
3. **屏幕分辨率** - 按钮坐标应根据实际屏幕分辨率调整
4. **网络连接** - 确保模拟器与主机的网络连接正常
5. **权限** - 确保有权限访问模拟器和截图文件

## 相关文件

- `auto_market_query.py` - 主脚本
- `tests/test_auto_market_query.py` - 单元测试
- `ocr_helper.py` - OCR 辅助工具
- `emulator_manager.py` - 模拟器管理工具
- `logger_config.py` - 日志配置

## 更新日志

详见 `CHANGELOG.md` 中的"自动化市场查询脚本"相关条目。

